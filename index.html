<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Orhun Ege Eker — Space Portfolio</title>
<link rel="icon" type="image/png" href="media/favicon.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;800&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#05060a; --text:#f6f7fb; --muted:#cbd5e1; --accent:#1e5eff; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:hidden}
  canvas#scene{position:fixed;inset:0;width:100%;height:100%;display:block}

  .hud{position:fixed;top:12px;left:12px;right:12px;z-index:20;display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:rgba(8,10,18,.45);border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(8px);border-radius:16px}
  .brand{font-weight:800;letter-spacing:.4px;font-size:16px}
  .nav{display:flex;gap:16px}
  .nav a{color:var(--text);text-decoration:none;opacity:.9;font-size:14px}

  .help{position:fixed;right:12px;bottom:12px;z-index:20;color:var(--muted);font-size:12px;padding:10px 12px;border:1px solid rgba(255,255,255,.12);border-radius:12px;background:rgba(255,255,255,.06);backdrop-filter:blur(6px)}

  .overlay{position:fixed;inset:0;pointer-events:none;z-index:12}
  .planet-card{position:absolute;transform:translate(-50%,-100%);width:240px;max-width:40vw;border-radius:12px;overflow:hidden;border:1px solid rgba(120,198,255,.28);background:linear-gradient(180deg, rgba(20,24,40,.85), rgba(10,12,20,.9));box-shadow:0 10px 26px rgba(0,0,0,.45);transition:opacity .15s ease, transform .15s ease;opacity:.0; pointer-events:auto}
  .planet-card__media{position:relative;height:120px;background:#0f1430;background-size:cover;background-position:center}
  .planet-card__media::after{content:""; position:absolute; inset:0; pointer-events:none; z-index:1; background: radial-gradient(240px 160px at 50% 50%, rgba(0,0,0,.55), transparent 70%);}
  .planet-card__meta{display:flex;justify-content:space-between;align-items:center;padding:8px 10px}
  .title{font-weight:700}
  .badge{position:absolute;left:8px;top:8px;background:rgba(64,191,255,.12);border:1px solid rgba(64,191,255,.4);backdrop-filter:blur(6px);font-size:11px;padding:6px 8px;border-radius:999px;color:#cfefff; z-index:2}
  .enter-pill{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); padding:8px 12px; border-radius:999px; border:1px solid rgba(120,198,255,.65); background:linear-gradient(180deg, rgba(10,14,28,.85), rgba(12,16,30,.88)); box-shadow: 0 2px 14px rgba(0,0,0,.55), 0 0 24px rgba(64,191,255,.35) inset; color:#e9f4ff; font-size:11px; font-weight:700; letter-spacing:.2px; opacity:0; transition:opacity .15s ease, transform .15s ease; pointer-events:none; z-index:2; backdrop-filter: blur(4px) saturate(120%);}
  .enter-pill b{font-weight:800}
  @keyframes pillPulse {0%{transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-50%) scale(1.06)}100%{transform:translate(-50%,-50%) scale(1)}}
  .enter-pill.show{ animation: pillPulse 1.6s ease-in-out infinite; }

  .popup{position:fixed;inset:0;z-index:60;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);backdrop-filter:blur(4px)}
  .popup.show{display:flex}
  .popup-card{width:min(980px,94vw);border:1px solid rgba(120,198,255,.28);border-radius:16px;background:#0b0f1c;box-shadow:0 20px 60px rgba(0,0,0,.55);overflow:hidden}
  .popup-media{height:min(42vh,360px);background:#0e1433;background-size:cover;background-position:center}
  .popup-body{padding:14px;display:flex;align-items:center;justify-content:space-between;gap:10px}
  .popup-title{font-weight:800}
  .popup-tag{font-size:12px;color:#cfd6e3}
  .popup-actions{display:flex;gap:10px}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid rgba(120,198,255,.3);background:#10172b;color:#fff;font-size:14px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:#2b66ff}

  .viewer{position:fixed;inset:0;z-index:70;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);backdrop-filter:blur(6px)}
  .viewer.show{display:flex}
  .viewer-card{width:min(1200px,96vw);max-height:92vh;overflow:auto;border:1px solid rgba(120,198,255,.28);border-radius:16px;background:#0b0f1c;box-shadow:0 24px 70px rgba(0,0,0,.6)}
  .viewer-head{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.08)}
  .viewer-title{font-weight:800}.viewer-tag{font-size:12px;color:#cfd6e3;opacity:.9}
  .viewer-body{padding:16px 18px}
  .viewer-grid{display:grid;gap:14px;grid-template-columns:1fr}
  @media(min-width:880px){.viewer-grid{grid-template-columns:1.6fr 1fr}}
  .viewer-media{height:min(68vh,640px);background:#0e1433;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.08)}
  .viewer-media>video,.viewer-media>iframe{width:100%;height:100%;display:block;border:0}
  .viewer-stack{display:grid;gap:12px}
  .viewer-gifs,.viewer-gallery{display:grid;gap:10px}
  .viewer-gifs{grid-template-columns:repeat(2,1fr)}
  .viewer-gallery{grid-template-columns:repeat(3,1fr)}
  .viewer-gifs img,.viewer-gallery img{width:100%;height:100%;object-fit:cover;border-radius:10px;border:1px solid rgba(255,255,255,.08)}
  /* Yön duyarlı yerleşim */
  .viewer-gifs img,.viewer-gallery img{aspect-ratio:16/9}
  .viewer-gifs img.portrait,.viewer-gallery img.portrait{object-fit:contain;aspect-ratio:3/4;background:#0e1433}
  .viewer-desc{margin-top:12px;color:#d7deea;line-height:1.6}

  .start{position:fixed;inset:0;z-index:50;display:flex;align-items:center;justify-content:center;background:radial-gradient(1200px 600px at 50% -20%, rgba(120,170,255,.08), rgba(5,6,10,.95))}
  .start.hide{animation:fade .6s both}@keyframes fade{to{opacity:0;visibility:hidden}}
  .start-card{padding:22px 24px;border:1px solid rgba(255,255,255,.12);background:rgba(10,12,20,.72);backdrop-filter:blur(8px);border-radius:16px;display:flex;flex-direction:column;gap:10px;align-items:center;min-width:260px}
  .start-card h1{margin:0;font-weight:800;letter-spacing:.2px;text-align:center}
  .start-sub{margin:0 0 8px;color:#d0d7e4;opacity:.92;text-align:center}
  .kbd{font-weight:700;border:1px solid rgba(255,255,255,.18);padding:2px 6px;border-radius:6px;background:rgba(255,255,255,.06)}
  .actions{display:flex;gap:10px;margin-top:4px;flex-wrap:wrap;justify-content:center}
  .btn.linklike{background:transparent}

  .mobile-gate{position:fixed;inset:0;z-index:70;display:none;align-items:center;justify-content:center;background:radial-gradient(800px 400px at 50% 50%, rgba(120,170,255,.12), rgba(5,6,10,.95));backdrop-filter:blur(6px)}
  .mobile-card{padding:24px 28px;border:1px solid rgba(255,255,255,.18);background:linear-gradient(180deg, rgba(20,24,40,.9), rgba(10,12,20,.95));border-radius:20px;max-width:360px;text-align:center;box-shadow:0 8px 24px rgba(0,0,0,.4)}
  .mobile-card h2{margin:0 0 10px}
  .mobile-card p{margin:0 0 16px;line-height:1.5}
  .mobile-card .btn.primary{padding:12px 20px;border-radius:12px}

  /* --- İndirmeyi zorlaştır: viewer içindeki medya için sağ tık, seçim ve sürüklemeyi kapat --- */
  .viewer img, .viewer video { -webkit-user-drag: none; user-select: none; }
  .viewer .viewer-media video { pointer-events: none; } /* tıklanamaz video */
</style>
</head>
<body>
  <div class="hud">
    <div class="brand">ORHUN EGE EKER</div>
    <div class="nav">
      <a href="index.html">SPACE</a>
      <a href="projects.html">PROJECTS</a>
      <a href="about.html">ABOUT</a>
      <a href="contact.html">CONTACT</a>
    </div>
  </div>

  <div class="help" id="helpBox">Loading controls…</div>
  <div class="overlay" id="overlay"></div>

  <div class="popup" id="quickview" aria-hidden="true">
    <div class="popup-card" role="dialog" aria-modal="true">
      <div class="popup-media" id="qvMedia"></div>
      <div class="popup-body">
        <div>
          <div class="popup-title" id="qvTitle">Project</div>
          <div class="popup-tag" id="qvTag">Category</div>
        </div>
        <div class="popup-actions">
          <button class="btn primary" id="qvOpen" type="button">View Project (E)</button>
          <button class="btn" id="qvExit" type="button">Quit (Q)</button>
        </div>
      </div>
    </div>
  </div>

  <div class="viewer" id="viewer" aria-hidden="true">
    <div class="viewer-card">
      <div class="viewer-head">
        <div>
          <div class="viewer-title" id="vwTitle">Title</div>
          <div class="viewer-tag" id="vwTag">Tag</div>
        </div>
        <button class="btn" id="vwClose" type="button">Close (Q)</button>
      </div>
      <div class="viewer-body">
        <div class="viewer-grid">
          <div class="viewer-media" id="vwVideo"></div>
          <div class="viewer-stack">
            <div class="viewer-gifs" id="vwGifs"></div>
            <div class="viewer-gallery" id="vwImages"></div>
          </div>
        </div>
        <div class="viewer-desc" id="vwDesc"></div>
      </div>
    </div>
  </div>

  <div class="start" id="start">
    <div class="start-card">
      <h1>Orhun Ege Eker — Space Tour</h1>
      <div class="start-sub">Explore projects in a tiny galaxy</div>
      <div class="actions">
        <a class="btn linklike" href="projects.html">Basic Portfolio</a>
        <button id="btnStart" class="btn primary" type="button">Start</button>
      </div>
      <p style="margin:8px 0 0;opacity:.85">
        <span class="kbd">W/S</span> move · mouse turn · near planet <span class="kbd">E</span> view
      </p>
    </div>
  </div>

  <div class="mobile-gate" id="mobileGate">
    <div class="mobile-card">
      <h2>Hey there!</h2>
      <p>This space adventure is best enjoyed on a computer for now. Want to check out my projects? Hop over to the basic portfolio instead!</p>
      <a class="btn primary" href="projects.html">Explore Basic Portfolio</a>
    </div>
  </div>

  <canvas id="scene"></canvas>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }
  }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    const isTouch = matchMedia('(pointer:coarse)').matches || ('ontouchstart' in window);
    const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

    const mobileGate = document.getElementById('mobileGate');
    if (isTouch) mobileGate.style.display = 'flex';

    const helpBox=document.getElementById('helpBox');
    helpBox.innerHTML = isTouch
      ? '<b>Mobile</b> — This space tour shines on desktop! Try the Basic Portfolio for now.'
      : '<b>Desktop</b> — Mouse: turn · <b>W/S</b> forward/back · <b>A/D</b> yaw · Near planet: <b>E</b> view · In modal: <b>Q</b> close';

    /* ---------- Projeleri JSON'dan yükle (fallback ile) ---------- */
    const FALLBACK_PROJECTS = [
      {id:'p1',title:'Audio Reactive + Hand Tracked Visualizer',tag:'TouchDesigner',cover:'media/covers/p1.jpg',type:'moon',
       video:'media/project1/video.mp4', gifs:['media/project1/gif1.gif','media/project1/gif2.gif'], images:['media/project1/img1.jpg','media/project1/img2.jpg','media/project1/img3.jpg'], description:'Placeholder — explain the piece here.'},
      {id:'p2',title:'Odin Pendant Animation',tag:'3D Works',cover:'media/covers/p2.jpg',type:'rocky',
       video:'media/project2/video.mp4', gifs:['media/project2/gif1.gif','media/project2/gif2.gif'], images:['media/project2/img1.jpg','media/project2/img2.jpg','media/project2/img3.jpg'], description:'Placeholder.'},
      {id:'p3',title:'MediaPipe + Ableton + PointCloud',tag:'Interactive',cover:'media/covers/p3.jpg',type:'gas',
       video:'media/project3/video.mp4', gifs:['media/project3/gif1.gif','media/project3/gif2.gif'], images:['media/project3/img1.jpg','media/project3/img2.jpg','media/project3/img3.jpg'], description:'Placeholder.'},
      {id:'p4',title:'Nike Air Jordan CGI',tag:'CGI',cover:'media/covers/p4.jpg',type:'rocky',
       video:'media/project4/video.mp4', gifs:['media/project4/gif1.gif','media/project4/gif2.gif'], images:['media/project4/img1.jpg','media/project4/img2.jpg','media/project4/img3.jpg'], description:'Placeholder.'},
      {id:'p5',title:'Bic Mini Lighter Spider Case',tag:'Product CGI',cover:'media/covers/p5.jpg',type:'moon',
       video:'media/project5/video.mp4', gifs:['media/project5/gif1.gif','media/project5/gif2.gif'], images:['media/project5/img1.jpg','media/project5/img2.jpg','media/project5/img3.jpg'], description:'Placeholder.'},
      {id:'p6',title:'Space Keycap Animation',tag:'3D Works',cover:'media/covers/p6.jpg',type:'gas',
       video:'media/project6/video.mp4', gifs:['media/project6/gif1.gif','media/project6/gif2.gif'], images:['media/project6/img1.jpg','media/project6/img2.jpg','media/project6/img3.jpg'], description:'Placeholder.'},
      {id:'p7',title:'Oxidized Silver Jewelry — Maverick',tag:'LookDev',cover:'media/covers/p7.jpg',type:'rocky',
       video:'media/project7/video.mp4', gifs:['media/project7/gif1.gif','media/project7/gif2.gif'], images:['media/project7/img1.jpg','media/project7/img2.jpg','media/project7/img3.jpg'], description:'Placeholder.'},
      {id:'p8',title:'YouTube Channel Intro',tag:'Motion · Audio',cover:'media/covers/p8.jpg',type:'moon',
       video:'media/project8/video.mp4', gifs:['media/project8/gif1.gif','media/project8/gif2.gif'], images:['media/project8/img1.jpg','media/project8/img2.jpg','media/project8/img3.jpg'], description:'Placeholder.'},
      {id:'p9',title:'AI Visualizer from Image',tag:'AI Visuals',cover:'media/covers/p9.jpg',type:'gas',
       video:'media/project9/video.mp4', gifs:['media/project9/gif1.gif','media/project9/gif2.gif'], images:['media/project9/img1.jpg','media/project9/img2.jpg','media/project9/img3.jpg'], description:'Placeholder.'}
    ];

    async function loadProjects(){
      try{
        const res = await fetch('projects.json', {cache:'no-store'});
        if(!res.ok) throw new Error('fetch failed');
        const text = await res.text();
        const data = JSON.parse(text.trim());
        const arr = Array.isArray(data) ? data : (Array.isArray(data.projects) ? data.projects : null);
        if(!arr) throw new Error('malformed JSON');
        return arr;
      }catch(e){
        console.warn('projects.json yüklenemedi, fallback kullanılıyor:', e);
        return FALLBACK_PROJECTS;
      }
    }

    /* ---------- Basit yardımcılar ---------- */
    function makeRadialTexture(inner, outer, size=128){
      const c=document.createElement('canvas'); c.width=c.height=size;
      const ctx=c.getContext('2d');
      const g=ctx.createRadialGradient(size/2,size/2,0,size/2,size/2,size/2);
      g.addColorStop(0,inner); g.addColorStop(1,outer);
      ctx.fillStyle=g; ctx.fillRect(0,0,size,size);
      const t=new THREE.CanvasTexture(c);
      t.minFilter=THREE.LinearFilter; t.magFilter=THREE.LinearFilter; return t;
    }
    const flameTex = makeRadialTexture('rgba(120,230,255,1)','rgba(0,170,255,0)');
    const smokeTex = makeRadialTexture('rgba(160,210,255,0.55)','rgba(90,140,200,0)');

    /* ---------- Scene ---------- */
    const renderer = new THREE.WebGLRenderer({canvas:document.getElementById('scene'), antialias:true});
    renderer.setPixelRatio(Math.min(2, devicePixelRatio||1)); renderer.setSize(innerWidth, innerHeight);
    const scene = new THREE.Scene(); scene.background = new THREE.Color(0x05060a);
    const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 6000);

    scene.add(new THREE.HemisphereLight(0x89b4ff, 0x05060a, .55));
    const sun = new THREE.DirectionalLight(0xffffff,.85); sun.position.set(160,220,120); scene.add(sun);

    /* ---------- Stars ---------- */
    (function(){
      const g=new THREE.BufferGeometry(), N=2500, pos=new Float32Array(N*3);
      for(let i=0;i<N;i++){const R=900+Math.random()*1400, th=Math.random()*Math.PI*2, u=Math.random()*2-1, s=Math.sqrt(1-u*u);
        pos[i*3]=R*s*Math.cos(th); pos[i*3+1]=R*u*0.7; pos[i*3+2]=R*s*Math.sin(th);} 
      g.setAttribute('position', new THREE.BufferAttribute(pos,3));
      scene.add(new THREE.Points(g,new THREE.PointsMaterial({size:1.6,color:0xbfd9ff,sizeAttenuation:true})));
    })();

    /* ---------- Planet helpers (özet) ---------- */
    function seededRand(seed){ let t = seed >>> 0; return ()=>((t = (1664525*t + 1013904223)>>>0)/0xffffffff); }
    const sphereGeo=new THREE.SphereGeometry(1,96,72);
    function makeMoonTextures(seed){ const rnd=seededRand(seed), s=1024, c=document.createElement('canvas'); c.width=c.height=s; const ctx=c.getContext('2d');
      ctx.fillStyle='#6f7178'; ctx.fillRect(0,0,s,s);
      for(let i=0;i<220;i++){ const x=rnd()*s,y=rnd()*s,r=8+rnd()*42; const g=ctx.createRadialGradient(x,y,0,x,y,r); g.addColorStop(0,'#54565b'); g.addColorStop(.6,'#686a70'); g.addColorStop(1,'rgba(110,110,115,.35)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }
      const tex=new THREE.CanvasTexture(c);
      const ch=document.createElement('canvas'); ch.width=ch.height=s; const hx=ch.getContext('2d');
      hx.fillStyle='#000'; hx.fillRect(0,0,s,s);
      for(let i=0;i<220;i++){ const x=rnd()*s,y=rnd()*s,r=8+rnd()*42; const g=hx.createRadialGradient(x,y,0,x,y,r); g.addColorStop(0,'#fff'); g.addColorStop(.6,'#aaa'); g.addColorStop(1,'rgba(0,0,0,0)'); hx.fillStyle=g; hx.beginPath(); hx.arc(x,y,r,0,Math.PI*2); hx.fill(); }
      const disp=new THREE.CanvasTexture(ch); return {map:tex, disp}; }
    function makeRockyTextures(seed){ const rnd=seededRand(seed), s=1024, c=document.createElement('canvas'); c.width=c.height=s; const ctx=c.getContext('2d');
      ctx.fillStyle='#8b5a2b'; ctx.fillRect(0,0,s,s);
      for(let i=0;i<160;i++){ const x=rnd()*s,y=rnd()*s,r=10+rnd()*36; const g=ctx.createRadialGradient(x,y,0,x,y,r); g.addColorStop(0,'#a66a36'); g.addColorStop(1,'rgba(139,69,19,0.35)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }
      const tex=new THREE.CanvasTexture(c);
      const ch=document.createElement('canvas'); ch.width=ch.height=s; const hx=ch.getContext('2d');
      hx.fillStyle='#000'; hx.fillRect(0,0,s,s);
      for(let i=0;i<150;i++){ const x=rnd()*s,y=rnd()*s,r=10+rnd()*32; const g=hx.createRadialGradient(x,y,0,x,y,r); g.addColorStop(0,'#fff'); g.addColorStop(1,'rgba(0,0,0,0)'); hx.fillStyle=g; hx.beginPath(); hx.arc(x,y,r,0,Math.PI*2); hx.fill(); }
      const disp=new THREE.CanvasTexture(ch); return {map:tex, disp}; }
    function makeGasTextures(seed){ const rnd=seededRand(seed), s=1024, c=document.createElement('canvas'); c.width=c.height=s; const ctx=c.getContext('2d');
      for(let y=0;y<s;y++){ const t=y/s; const r=60+80*Math.sin(6*t + seed*0.13), g=120+120*Math.sin(8*t + seed*0.21), b=160+80*Math.sin(5*t + seed*0.31); ctx.fillStyle=`rgb(${r|0},${g|0},${b|0})`; ctx.fillRect(0,y,s,1); }
      for(let i=0;i<50;i++){ const x=rnd()*s,y=rnd()*s,rx=40+rnd()*90,ry=20+rnd()*60; ctx.fillStyle='rgba(255,255,255,0.12)'; ctx.beginPath(); ctx.ellipse(x,y,rx,ry, rnd()*Math.PI, 0, Math.PI*2); ctx.fill(); }
      const tex=new THREE.CanvasTexture(c);
      const ch=document.createElement('canvas'); ch.width=ch.height=s; const hx=ch.getContext('2d'); const grad=hx.createLinearGradient(0,0,0,s); grad.addColorStop(0,'#777'); grad.addColorStop(.5,'#bbb'); grad.addColorStop(1,'#777'); hx.fillStyle=grad; hx.fillRect(0,0,s,s);
      const disp=new THREE.CanvasTexture(ch); return {map:tex, disp}; }
    function appearanceForType(type){
      if(type==='moon')  return {h:0.0,s:0.10,l:0.42,metal:0.2,rough:0.85,ring:false,emiss:0.10};
      if(type==='rocky') return {h:0.08,s:0.50,l:0.32,metal:0.3,rough:0.70,ring:Math.random()<0.25,emiss:0.10};
      if(type==='gas')   return {h:0.58,s:0.60,l:0.50,metal:0.1,rough:0.95,ring:Math.random()<0.40,emiss:0.25};
      return {h:0.66,s:0.40,l:0.58,metal:0.22,rough:0.55,ring:Math.random()<0.5,emiss:0.18};
    }
    function makePlanet(r, type, seed){
      let tex; if(type==='moon') tex=makeMoonTextures(seed); else if(type==='rocky') tex=makeRockyTextures(seed); else tex=makeGasTextures(seed);
      const app = appearanceForType(type);
      const col=new THREE.Color().setHSL(app.h,app.s,app.l);
      const mat = new THREE.MeshStandardMaterial({
        color:col.getHex(), roughness:app.rough, metalness:app.metal,
        emissive:col.clone().multiplyScalar(app.emiss).getHex(), emissiveIntensity:1,
        map:tex.map, displacementMap:tex.disp, displacementScale:(type==='gas'?0.06:0.18),
        normalMap:tex.disp, normalScale:new THREE.Vector2(0.7,0.7)
      });
      const m=new THREE.Mesh(sphereGeo,mat);
      m.rotation.z = THREE.MathUtils.degToRad(THREE.MathUtils.randFloatSpread(12));
      if(app.ring){
        const ring=new THREE.Mesh(new THREE.RingGeometry(r*1.015,r*1.06,72),
          new THREE.MeshBasicMaterial({color:col.clone().offsetHSL(.08,0,0).getHex(),transparent:true,opacity:.12,side:THREE.DoubleSide}));
        ring.rotation.x=-Math.PI/2 + THREE.MathUtils.randFloatSpread(.28);
        ring.rotation.z=Math.random()*Math.PI*2; m.add(ring);
      }
      m.scale.setScalar(r); m.userData.spin=THREE.MathUtils.randFloat(0.02,0.05);
      return m;
    }

    /* ---------- Overlay kartları ---------- */
    const overlay=document.getElementById('overlay');
    const planets=[], cardsRef=[], tmpV=new THREE.Vector3();

    /* ---------- Player ship + particles ---------- */
    const ship=new THREE.Group(); scene.add(ship);
    const defaultHull=new THREE.Mesh(new THREE.CapsuleGeometry(.8,3,6,12),
      new THREE.MeshStandardMaterial({color:0x9aa7ff,roughness:.55,metalness:.2,emissive:0x10163a,emissiveIntensity:.2}));
    defaultHull.rotation.z=Math.PI/2; ship.add(defaultHull);

    const loader = new GLTFLoader();
    let exhaustLocal=new THREE.Vector3(-2,0,0);
    let sharedAIModel = null;
    let aiSpawned = false;

    loader.load('media/spaceship.glb',
      (gltf)=>{
        const model = gltf.scene || gltf.scenes?.[0]; if(!model) return;
        ship.clear();
        // Oyuncu gemisini normalize et
        const box0 = new THREE.Box3().setFromObject(model);
        const size0 = new THREE.Vector3(); box0.getSize(size0);
        const s = 6 / Math.max(size0.x,size0.y,size0.z || 1);
        model.scale.setScalar(s);
        model.rotation.set(0, Math.PI/2, 0);
        // merkeze al
        const b1 = new THREE.Box3().setFromObject(model);
        const c1 = new THREE.Vector3(); b1.getCenter(c1); model.position.sub(c1);
        // egzoz offsetini bul
        const b2 = new THREE.Box3().setFromObject(model);
        exhaustLocal = new THREE.Vector3(b2.min.x - 0.6, 0, 0);
        ship.add(model);

        // AI için: materyal tonlamalı klon (tek seferlik şablon)
        sharedAIModel = model.clone(true);
        sharedAIModel.traverse(o=>{
          if(o.isMesh){
            o.material = o.material.clone();
            o.material.color.offsetHSL(0.5,0,0);
            o.material.emissive = new THREE.Color(0x99ccff);
            o.material.emissiveIntensity = 0.35;
          }
        });
        // Oyuncu modelini 6 birime sığdırdık; AI'lar biraz daha küçük dursun
        sharedAIModel.scale.multiplyScalar(3.2/6);

        if (!aiSpawned) { spawnAIShips(); aiSpawned = true; }
      },
      undefined,
      (err)=>{ console.error('GLB load error (player/AI):', err); }
    );

    function worldFromExhaust_player(out){return out.copy(exhaustLocal).applyQuaternion(ship.quaternion).add(ship.position);}

    /* ---------- Particle materials + pools ---------- */
    const flameMat=new THREE.SpriteMaterial({map:flameTex,transparent:true,blending:THREE.AdditiveBlending,depthWrite:false,opacity:.95});
    const smokeMat=new THREE.SpriteMaterial({map:smokeTex,transparent:true,depthWrite:false,opacity:.0});
    function makeSprite(mat){const s=new THREE.Sprite(mat.clone()); s.visible=false; scene.add(s); return s;}

    const flamePool=[...Array(140)].map(()=>makeSprite(flameMat)), smokePool=[...Array(100)].map(()=>makeSprite(smokeMat));
    const flameData=flamePool.map(()=>({life:0,max:0,vel:new THREE.Vector3()})), smokeData=smokePool.map(()=>({life:0,max:0,vel:new THREE.Vector3()}));

    function spawnFlame_player(n,intensity=1){
      for(let i=0;i<flamePool.length&&n>0;i++){
        if(flameData[i].life>0)continue; n--;
        const sp=flamePool[i],d=flameData[i]; const pos=new THREE.Vector3(); worldFromExhaust_player(pos);
        sp.position.copy(pos); sp.scale.setScalar(1.0+Math.random()*1.6*intensity);
        d.max=.38+Math.random()*.28; d.life=d.max;
        const dir=new THREE.Vector3(-1,THREE.MathUtils.randFloatSpread(.35),THREE.MathUtils.randFloatSpread(.35)).applyQuaternion(ship.quaternion);
        d.vel.copy(dir.multiplyScalar(13+20*intensity)); sp.material.opacity=.95; sp.visible=true;
      }
    }
    function spawnSmoke_player(n,boost=1){
      for(let i=0;i<smokePool.length&&n>0;i++){
        if(smokeData[i].life>0)continue; n--;
        const sp=smokePool[i],d=smokeData[i]; const pos=new THREE.Vector3(); worldFromExhaust_player(pos);
        sp.position.copy(pos); const s=1.4+Math.random()*2.4*boost; sp.scale.set(s,s,1);
        d.max=1.0+Math.random()*.9; d.life=d.max;
        const dir=new THREE.Vector3(-1,THREE.MathUtils.randFloatSpread(.25),THREE.MathUtils.randFloatSpread(.25)).applyQuaternion(ship.quaternion);
        d.vel.copy(dir.multiplyScalar(3+2.2*boost)); sp.material.opacity=.35; sp.visible=true;
      }
    }
    function updateParticles_player(dt){
      for(let i=0;i<flamePool.length;i++){
        const p=flamePool[i],d=flameData[i]; if(d.life<=0){p.visible=false;continue;}
        d.life-=dt; p.position.addScaledVector(d.vel,dt);
        const t=d.life/d.max; p.material.opacity=.18+.77*t; const s=(.7+1.9*(1-t)); p.scale.set(s,s,1);
        if(d.life<=0)p.visible=false;
      }
      for(let i=0;i<smokePool.length;i++){
        const p=smokePool[i],d=smokeData[i]; if(d.life<=0){p.visible=false;continue;}
        d.life-=dt; p.position.addScaledVector(d.vel,dt); p.position.y+=dt*.6;
        const t=d.life/d.max; p.material.opacity=.35*t; const s=p.scale.x*(1+.35*dt); p.scale.set(s,s,1);
        if(d.life<=0)p.visible=false;
      }
    }

    /* ---------- Kamera ---------- */
    const camOff=new THREE.Vector3(-20,8.8,0), lookAhead=new THREE.Vector3(8,2,0), camPos=new THREE.Vector3(), lookAt=new THREE.Vector3();
    function updateCamera(dt){
      const off=camOff.clone().applyQuaternion(ship.quaternion);
      camPos.copy(ship.position).add(off);
      camera.position.lerp(camPos,1-Math.pow(.0028,dt*60));
      const la=lookAhead.clone().applyQuaternion(ship.quaternion);
      lookAt.copy(ship.position).add(la); camera.lookAt(lookAt);
    }
    camera.position.copy(ship.position).add(camOff); camera.lookAt(ship.position.clone().add(lookAhead));

    /* ---------- Input ---------- */
    let controlsEnabled=false;
    const keys={KeyW:false,KeyA:false,KeyS:false,KeyD:false};
    addEventListener('keydown',e=>{ if(!controlsEnabled) return; if(e.code in keys) keys[e.code]=true; });
    addEventListener('keyup',e=>{ if(!controlsEnabled) return; if(e.code in keys) keys[e.code]=false; });

    let lastX=null,lastY=null,yawVel=0,pitchVel=0; 
    const M_SENS_X=.0048, M_SENS_Y=.0042, YAW_D=.90, PITCH_D=.90, MAX_YAW=2.8;
    addEventListener('mousemove',e=>{
      if(!controlsEnabled||isTouch) return;
      if(lastX===null){lastX=e.clientX;lastY=e.clientY;return;}
      const dx=e.clientX-lastX,dy=e.clientY-lastY; lastX=e.clientX; lastY=e.clientY;
      yawVel += dx*M_SENS_X; pitchVel += -dy*M_SENS_Y;
    }, {passive:true});
    addEventListener('mouseleave',()=>{lastX=lastY=null;}); addEventListener('blur',()=>{lastX=lastY=null;});

    /* ---------- Movement + collisions ---------- */
    let velF=0,yaw=0,pitch=0,throttle=0,prevThrottle=0,turnKeyVel=0;
    let inputFwd = 0;

    const BOUNDS_R = 230, BOUNDS_SOFT = 200;

    function planetRadius(p){ return p.scale.x; }

    function handleCollisions(){
      for(const pl of planets){
        const r = planetRadius(pl)*0.98;
        const d = ship.position.distanceTo(pl.position);
        if(d < r+1.6){
          const dir = ship.position.clone().sub(pl.position).normalize();
          ship.position.copy(pl.position).addScaledVector(dir, r+1.6);
          yaw += THREE.MathUtils.randFloatSpread(0.06);
          pitch += THREE.MathUtils.randFloatSpread(0.04);
          velF *= 0.4;
          spawnSmoke_player(8,1.4);
        }
      }
      const dist = ship.position.length();
      if(dist > BOUNDS_R){
        const toCenter = ship.position.clone().multiplyScalar(-1).normalize();
        yaw += THREE.MathUtils.randFloatSpread(0.02);
        pitch += THREE.MathUtils.randFloatSpread(0.02);
        ship.position.addScaledVector(toCenter, (dist-BOUNDS_R)*0.6);
        velF *= 0.7;
      }
    }

    function updateShip(dt){
      if(!controlsEnabled){ velF*=Math.pow(.94,dt*60); yawVel*=Math.pow(.92,dt*60); pitchVel*=Math.pow(.92,dt*60); updateParticles_player(dt); return; }
      let fwd=0, turnKey=0;
      if(!isTouch){ if(keys.KeyW)fwd+=1; if(keys.KeyS)fwd-=1; if(keys.KeyD)turnKey-=1; if(keys.KeyA)turnKey+=1; }
      inputFwd = fwd;

      yawVel*=Math.pow(YAW_D,dt*60); pitchVel*=Math.pow(PITCH_D,dt*60); turnKeyVel=THREE.MathUtils.damp(turnKeyVel,turnKey*1.2,6,dt);
      const yawRate=THREE.MathUtils.clamp((yawVel+turnKeyVel)*3.0,-MAX_YAW,MAX_YAW), pitchRate=THREE.MathUtils.clamp(pitchVel*3.0,-1.6,1.6);
      yaw+=yawRate*dt; pitch+=pitchRate*dt; pitch=clamp(pitch,-Math.PI/3,Math.PI/3);

      const ACC=26, MAX=26, DRAG_C=.985, DRAG_A=.96, DRAG_B=.90;
      const tTarget=Math.max(0,fwd);
      throttle += (tTarget-throttle)*(1-Math.pow(.2,dt*60));
      velF+=throttle*ACC*dt; if(fwd<0) velF+=fwd*ACC*dt;
      const drag=(fwd<0)?DRAG_B:(throttle>.02?DRAG_A:DRAG_C);
      velF*=Math.pow(drag,dt*60); velF=clamp(velF,-MAX,MAX);

      const dist = ship.position.length();
      if(dist > BOUNDS_SOFT){
        const toCenter = ship.position.clone().multiplyScalar(-1).normalize();
        const forward=new THREE.Vector3(1,0,0).applyQuaternion(ship.quaternion);
        const axis = forward.clone().cross(toCenter).normalize();
        const ang = Math.min(1.2*dt, forward.angleTo(toCenter));
        if(isFinite(ang) && axis.lengthSq()>1e-6){
          ship.quaternion.multiply(new THREE.Quaternion().setFromAxisAngle(axis, ang));
        }
      }

      const targetRoll=-(yawVel+turnKeyVel)*0.25;
      ship.rotation.set(pitch,yaw,THREE.MathUtils.damp(ship.rotation.z,targetRoll,8,dt));
      const forward=new THREE.Vector3(1,0,0).applyQuaternion(ship.quaternion);
      ship.position.addScaledVector(forward,velF*dt);
      ship.position.y += Math.sin(pitch)*velF*.75*dt; ship.position.y=clamp(ship.position.y,-70,70);

      const speedAbs=Math.abs(velF);
      const rate=Math.floor(6+14*clamp(throttle+speedAbs/20,0,1.5));
      if(inputFwd>0 && throttle>0.05){ spawnFlame_player(rate,clamp(throttle+speedAbs/30,.6,1.6)); }
      if((inputFwd<=0 && speedAbs>2) || (prevThrottle>.25 && throttle<=.02)){ spawnSmoke_player(2,1.1); }
      prevThrottle=throttle;

      handleCollisions();
      updateParticles_player(dt);
    }

    /* ---------- Overlay & Quickview ---------- */
    const qv=document.getElementById('quickview'), qvTitle=document.getElementById('qvTitle'),
          qvTag=document.getElementById('qvTag'), qvMedia=document.getElementById('qvMedia'),
          qvOpen=document.getElementById('qvOpen');
    const viewer=document.getElementById('viewer'), vwTitle=document.getElementById('vwTitle'),
          vwTag=document.getElementById('vwTag'), vwVideo=document.getElementById('vwVideo'),
          vwGifs=document.getElementById('vwGifs'), vwImages=document.getElementById('vwImages'),
          vwDesc=document.getElementById('vwDesc');

    let nearest=null, PROJECTS=[];
    function updateCardsAndHint(){
      const W=innerWidth,H=innerHeight; let best=null,dmin=Infinity;
      for(const {el,obj,pill} of cardsRef){
        tmpV.copy(obj.position); tmpV.y+=10; tmpV.project(camera);
        const on=tmpV.z<1&&tmpV.z>-1; let x=(tmpV.x*.5+.5)*W,y=(-tmpV.y*.5+.5)*H;
        if(on){ x=clamp(x,18,W-18); y=clamp(y,80,H-96); el.style.left=x+'px'; el.style.top=y+'px';
          const dist=camera.position.distanceTo(obj.position); const a=THREE.MathUtils.clamp(1-(dist-60)/220,0,1);
          el.style.opacity=a; el.style.transform=`translate(-50%,-100%) scale(${0.92+a*0.1})`;
        } else { el.style.opacity=0; }
        if(pill){ pill.style.opacity=0; pill.classList.remove('show'); }
        const d=ship.position.distanceTo(obj.position); if(d<dmin){dmin=d; best=obj;}
      }
      const TH=28; nearest=(best&&dmin<TH)?best:null;
      if(nearest && controlsEnabled && !qv.classList.contains('show')){
        const ref=cardsRef.find(c=>c.obj===nearest);
        if(ref && ref.pill){
          ref.pill.style.opacity = 0.98;
          ref.pill.classList.add('show');
        }
      }
    }
    function qvOpenFor(pl){
      controlsEnabled=false;
      const p=pl.userData.project;
      qvTitle.textContent=p.title; qvTag.textContent=p.tag||''; qvMedia.style.backgroundImage=`url('${p.cover||''}')`;
      qv.style.display='flex'; qv.classList.add('show'); qv.setAttribute('aria-hidden','false');
      qvOpen.onclick = ()=> openViewer(p);
    }
    function qvCloseFn(){ qv.classList.remove('show'); qv.style.display='none'; qv.setAttribute('aria-hidden','true'); controlsEnabled=true; }
    document.getElementById('qvExit').addEventListener('click',qvCloseFn);

    function markPortrait(img){
      if(img.naturalHeight > img.naturalWidth){ img.classList.add('portrait'); }
    }

    // Ses açık olacak projeler
    const SOUND_ON = new Set(['p3','p4','p6','p8','p9']);

    function openViewer(p){
      qvCloseFn();
      vwTitle.textContent=p.title; vwTag.textContent=p.tag||''; vwDesc.textContent=p.description||'';
      vwVideo.innerHTML=''; vwGifs.innerHTML=''; vwImages.innerHTML='';

      // --- Video (autoplay+loop; tıklanamaz; ses p3,p4,p6,p8,p9'da açık) ---
      if (p.video && p.video.trim() !== '') {
        vwVideo.style.display = ''; // göster
        if (/\.(mp4|webm)$/i.test(p.video)) {
          const vid = document.createElement('video');
          vid.autoplay = true;
          vid.loop = true;
          vid.playsInline = true;
          vid.preload = 'metadata';
          vid.src = p.video;

          // tıklanamaz ve indirmeyi zorlaştır
          vid.controls = false;
          vid.setAttribute('controlsList','nodownload noplaybackrate noremoteplayback');
          vid.setAttribute('disablePictureInPicture','');
          vid.addEventListener('contextmenu', e=>e.preventDefault());
          vid.addEventListener('dragstart', e=>e.preventDefault());
          vid.addEventListener('pointerdown', e=>e.preventDefault());

          if (SOUND_ON.has(p.id)) {
            vid.muted = false;
            vid.volume = 1.0;
            const tryPlay = () => vid.play().catch(()=>{});
            vid.addEventListener('canplay', tryPlay, { once: true });
            window.addEventListener('click', tryPlay, { once: true });
          } else {
            vid.muted = true;
          }
          vwVideo.appendChild(vid);
        } else {
          // YouTube/Vimeo gibi gömülü kaynaklar
          const sep = p.video.includes('?') ? '&' : '?';
          const muteParam = SOUND_ON.has(p.id) ? 'mute=0' : 'mute=1';
          const url = p.video + sep + `autoplay=1&${muteParam}&loop=1&playsinline=1`;
          const iframe = document.createElement('iframe');
          iframe.src = url;
          iframe.allow = 'autoplay; fullscreen; picture-in-picture';
          iframe.style.pointerEvents = 'none'; // tıklanamaz
          iframe.addEventListener('contextmenu', e=>e.preventDefault());
          vwVideo.appendChild(iframe);
        }
      } else {
        // video yoksa alanı tamamen gizle
        vwVideo.style.display = 'none';
      }

      // --- GIF’ler ---
      if(p.gifs && p.gifs.length){
        vwGifs.style.display='grid';
        p.gifs.slice(0,2).forEach(src=>{
          const img=new Image();
          img.onload=()=>markPortrait(img);
          img.src=src; img.loading='lazy';
          img.draggable=false;
          img.addEventListener('contextmenu',e=>e.preventDefault());
          img.addEventListener('dragstart',e=>e.preventDefault());
          vwGifs.appendChild(img);
        });
      } else {
        vwGifs.style.display='none';
      }

      // --- Görseller ---
      if(p.images && p.images.length){
        vwImages.style.display='grid';
        p.images.slice(0,6).forEach(src=>{
          const img=new Image();
          img.onload=()=>markPortrait(img);
          img.src=src; img.loading='lazy';
          img.draggable=false;
          img.addEventListener('contextmenu',e=>e.preventDefault());
          img.addEventListener('dragstart',e=>e.preventDefault());
          vwImages.appendChild(img);
        });
      } else {
        vwImages.style.display='none';
      }

      viewer.style.display='flex'; viewer.classList.add('show'); viewer.setAttribute('aria-hidden','false');
      controlsEnabled=false;
    }
    function closeViewer(){ viewer.classList.remove('show'); viewer.style.display='none'; viewer.setAttribute('aria-hidden','true'); controlsEnabled=true; }
    document.getElementById('vwClose').addEventListener('click',closeViewer);

    addEventListener('keydown',e=>{
      if(e.code==='KeyQ'){
        if(viewer.classList.contains('show')){ closeViewer(); return; }
        if(qv.classList.contains('show')){ qvCloseFn(); return; }
      }
      if(e.code==='KeyE'){
        if(qv.classList.contains('show')){ qvOpen.click(); }
        else if(controlsEnabled && nearest){ qvOpenFor(nearest); }
      }
    });

    // Viewer içinde medya indirilemeyi zorlaştır: sağ tık / seçim / sürükleme
    viewer.addEventListener('contextmenu', e=>{
      const t = e.target;
      if (t && (t.tagName==='IMG' || t.tagName==='VIDEO')) e.preventDefault();
    });
    viewer.addEventListener('dragstart', e=>e.preventDefault());
    viewer.addEventListener('selectstart', e=>{
      const t = e.target;
      if (t && (t.tagName==='IMG' || t.tagName==='VIDEO')) e.preventDefault();
    });

    /* ---------- AI ships + emitters (GLB model klonu) ---------- */
    function makeEmitter(){
      const flames=[...Array(32)].map(()=>makeSprite(flameMat));
      const smokes=[...Array(20)].map(()=>makeSprite(smokeMat));
      const fd=flames.map(()=>({life:0,max:0,vel:new THREE.Vector3()}));
      const sd=smokes.map(()=>({life:0,max:0,vel:new THREE.Vector3()}));
      function spawnFlameAt(pos,quat,intensity=1){
        const back = new THREE.Vector3(-1,THREE.MathUtils.randFloatSpread(.35),THREE.MathUtils.randFloatSpread(.35)).applyQuaternion(quat);
        for(let i=0;i<flames.length;i++){
          if(fd[i].life>0) continue;
          const sp=flames[i],d=fd[i];
          sp.position.copy(pos);
          sp.scale.setScalar(0.8+Math.random()*1.2*intensity);
          d.max=.30+Math.random()*.22; d.life=d.max;
          d.vel.copy(back).multiplyScalar(10+16*intensity);
          sp.material.opacity=.9; sp.visible=true;
          break;
        }
      }
      function spawnSmokeAt(pos,quat,boost=1){
        const back = new THREE.Vector3(-1,THREE.MathUtils.randFloatSpread(.25),THREE.MathUtils.randFloatSpread(.25)).applyQuaternion(quat);
        for(let i=0;i<smokes.length;i++){
          if(sd[i].life>0) continue;
          const sp=smokes[i],d=sd[i];
          sp.position.copy(pos);
          const s=1.0+Math.random()*2.0*boost; sp.scale.set(s,s,1);
          d.max=.8+Math.random()*.7; d.life=d.max;
          d.vel.copy(back).multiplyScalar(2.6+2.0*boost);
          sp.material.opacity=.3; sp.visible=true;
          break;
        }
      }
      function update(dt){
        for(let i=0;i<flames.length;i++){
          const p=flames[i],d=fd[i]; if(d.life<=0){p.visible=false;continue;}
          d.life-=dt; p.position.addScaledVector(d.vel,dt);
          const t=d.life/d.max; p.material.opacity=.15+.75*t; const s=(.6+1.6*(1-t)); p.scale.set(s,s,1);
          if(d.life<=0)p.visible=false;
        }
        for(let i=0;i<smokes.length;i++){
          const p=smokes[i],d=sd[i]; if(d.life<=0){p.visible=false;continue;}
          d.life-=dt; p.position.addScaledVector(d.vel,dt); p.position.y+=dt*.5;
          const t=d.life/d.max; p.material.opacity=.32*t; const s=p.scale.x*(1+.32*dt); p.scale.set(s,s,1);
          if(d.life<=0)p.visible=false;
        }
      }
      return {spawnFlameAt, spawnSmokeAt, update};
    }

    const AI_COUNT = 12;
    const aiShips = [];
    const center = new THREE.Vector3(0,0,0);

    function randomAITarget(){
      const r = Math.random()*150+20; const th=Math.random()*Math.PI*2; const u=Math.random()*2-1; const s=Math.sqrt(1-u*u);
      return new THREE.Vector3(s*Math.cos(th)*r, u*20, s*Math.sin(th)*r);
    }

    function spawnAIShips(){
      for(let i=0;i<AI_COUNT;i++){
        const grp=new THREE.Group();
        let body;

        if (sharedAIModel) {
          body = sharedAIModel.clone(true);
          // GLB klonu merkezlenmiş ve ölçeklenmiş durumda
          body.rotation.set(0, Math.PI/2, 0);
        } else {
          // GLB yüklenemezse son çare: kapsül (ama normalde GLB kullanılacak)
          const g=new THREE.CapsuleGeometry(.6,2.2,6,12);
          const m=new THREE.MeshStandardMaterial({color:0xffffff,metalness:.25,roughness:.5,emissive:0x111133,emissiveIntensity:.35});
          body=new THREE.Mesh(g,m); body.rotation.z=Math.PI/2;
        }

        // AI egzoz offsetini kutudan hesapla (glb’de doğru noktadan partikül çıksın)
        const tmp = new THREE.Box3().setFromObject(body);
        const aiExhaustLocal = new THREE.Vector3(tmp.min.x - 0.5, 0, 0);

        grp.add(body);
        grp.position.set(THREE.MathUtils.randFloatSpread(80),THREE.MathUtils.randFloatSpread(20),THREE.MathUtils.randFloatSpread(80));
        scene.add(grp);
        aiShips.push({
          g: grp,
          exhaustLocal: aiExhaustLocal,
          vel: THREE.MathUtils.randFloat(6,10),
          throttle: 0.4, prevThrottle: 0.4,
          target: randomAITarget(),
          cooldown: THREE.MathUtils.randFloat(2,5),
          emitter: makeEmitter()
        });
      }
    }

    function worldFromExhaust_ai(ai, out){
      return out.copy(ai.exhaustLocal).applyQuaternion(ai.g.quaternion).add(ai.g.position);
    }

    function updateAI(dt){
      const SOFT = 200, HARD=230;
      for(const ai of aiShips){
        ai.cooldown -= dt;
        if(ai.g.position.distanceTo(ai.target) < 10 || ai.cooldown<=0){
          ai.cooldown = THREE.MathUtils.randFloat(2,6);
          // %60 rastgele, %40 merkez yakınlarına hedef (leash)
          ai.target = (Math.random()<0.6) ? randomAITarget()
                                          : center.clone().add(new THREE.Vector3().randomDirection().multiplyScalar(THREE.MathUtils.randFloat(40,110)));
        }

        // yönel
        const dir = ai.target.clone().sub(ai.g.position); const dist = dir.length(); if(dist>0.0001) dir.normalize();
        const forward = new THREE.Vector3(1,0,0).applyQuaternion(ai.g.quaternion);
        const axis = forward.clone().cross(dir).normalize(); const ang = Math.min(1.0*dt, forward.angleTo(dir));
        if(isFinite(ang) && axis.lengthSq()>1e-6){ ai.g.quaternion.multiply(new THREE.Quaternion().setFromAxisAngle(axis, ang)); }

        // yumuşak merkez yayı (drift’i engeller)
        const kSpring = 0.06; // yay katsayısı
        const toCenter = center.clone().sub(ai.g.position);
        ai.g.position.addScaledVector(toCenter, kSpring*dt);

        // throttle yönetimi + hız
        const dCenter = ai.g.position.length();
        if(dCenter > SOFT){
          ai.throttle = Math.max(0.15, ai.throttle - 0.5*dt);
          // hedefi merkeze kır
          ai.target = center.clone().add(new THREE.Vector3().randomDirection().multiplyScalar(THREE.MathUtils.randFloat(40,100)));
        } else {
          if(dist>40) ai.throttle = Math.min(1.0, ai.throttle + 0.5*dt);
          else if(dist<18) ai.throttle = Math.max(0.1, ai.throttle - 0.8*dt);
        }

        ai.g.position.addScaledVector(forward, ai.vel * ai.throttle * dt);

        // sert sınır
        const dLen = ai.g.position.length();
        if(dLen > HARD){
          const pull = center.clone().sub(ai.g.position).normalize();
          ai.g.position.addScaledVector(pull, (dLen-HARD)*0.8*dt);
          ai.throttle = Math.max(0.2, ai.throttle - 0.6*dt);
        }
        ai.g.position.y = clamp(ai.g.position.y, -70, 70);

        // partiküller (ileri mavi alev, yavaşlayınca duman)
        const exhaustPos = worldFromExhaust_ai(ai, new THREE.Vector3());
        if(ai.throttle>0.22){ if(Math.random()<0.8) ai.emitter.spawnFlameAt(exhaustPos, ai.g.quaternion, 0.6+ai.throttle*0.6); }
        if(ai.prevThrottle>0.25 && ai.throttle<=0.12){ ai.emitter.spawnSmokeAt(exhaustPos, ai.g.quaternion, 1.2); }
        ai.prevThrottle = ai.throttle;

        ai.emitter.update(dt);
      }

      // AI ↔ oyuncu çarpışma yumuşatma
      for(const ai of aiShips){
        const d = ship.position.distanceTo(ai.g.position);
        if(d < 2.6){
          const dir = ship.position.clone().sub(ai.g.position).normalize();
          ship.position.addScaledVector(dir, 0.6);
          ai.g.position.addScaledVector(dir.negate(), 0.6);
          velF *= 0.7; ai.throttle = Math.max(0.25, ai.throttle*0.6);
          spawnSmoke_player(6,1.2);
        }
      }
    }

    /* ---------- Start ---------- */
    const startEl=document.getElementById('start');
    const START_KEY = 'spaceTourSeen';
    function maybeAutoStart(){
      if(localStorage.getItem(START_KEY)==='1'){
        startEl.classList.add('hide');
        controlsEnabled = true;
      }
    }
    document.getElementById('btnStart').addEventListener('click',()=>{
      localStorage.setItem(START_KEY,'1');
      startEl.classList.add('hide');
      setTimeout(()=>{ controlsEnabled=true; },550);
    });

    /* ---------- Resize & loop ---------- */
    addEventListener('resize',()=>{renderer.setSize(innerWidth,innerHeight); camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix();});
    const clock=new THREE.Clock();

    /* ---------- Kartlar ve gezegenleri kur ---------- */
    function buildPlanetsFromProjects(PROJECTS){
      const POS=[], RMIN=70, RMAX=150;
      for(let i=0;i<PROJECTS.length;i++){
        const R=THREE.MathUtils.randFloat(RMIN,RMAX), th=(i/PROJECTS.length)*Math.PI*2+Math.random()*0.6;
        POS.push([Math.cos(th)*R+THREE.MathUtils.randFloatSpread(20), THREE.MathUtils.randFloatSpread(18), Math.sin(th)*R+THREE.MathUtils.randFloatSpread(20)]);
      }
      for(let i=POS.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [POS[i],POS[j]]=[POS[j],POS[i]];}

      PROJECTS.forEach((p,i)=>{
        const r=THREE.MathUtils.randFloat(9,16), m=makePlanet(r, p.type||'moon', i*9973+123);
        const [x,y,z]=POS[i]; m.position.set(x,y,z); m.userData.project=p; scene.add(m); planets.push(m);

        const el=document.createElement('div'); el.className='planet-card';
        const cover = p.cover ? `background-image:url('${p.cover}')` : 'background-image:none';
        el.innerHTML=`<div class="planet-card__media" style="${cover}">
          <div class="badge">${p.tag||''}</div>
          <div class="enter-pill">Press <b>E</b> to View</div>
        </div>
        <div class="planet-card__meta"><div class="title">${p.title}</div></div>`;
        overlay.appendChild(el);
        const pill=el.querySelector('.enter-pill');
        const item={el,obj:m,pill}; el.addEventListener('click',()=>{ if(nearest===m) qvOpenFor(m); }); cardsRef.push(item);
      });
    }

    function loop(){
      const dt=Math.min(.033,clock.getDelta());
      updateShip(dt); updateCamera(dt); updateParticles_player(dt);
      for(const pl of planets){ pl.rotation.y += (pl.userData.spin||0.03)*dt; }
      updateAI(dt); updateCardsAndHint();
      renderer.render(scene,camera); requestAnimationFrame(loop);
    }

    /* ---------- Akış ---------- */
    (async function init(){
      const arr = await loadProjects();
      PROJECTS = arr;
      buildPlanetsFromProjects(PROJECTS);
      maybeAutoStart();
      loop();
    })();

    document.getElementById('qvExit').addEventListener('click',()=>qvCloseFn());
  </script>
</body>
</html>
